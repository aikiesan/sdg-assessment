version: '3.8'

services:
  # Test database - optimized for speed with tmpfs
  db-test:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=test_user
      - POSTGRES_PASSWORD=test_password
      - POSTGRES_DB=sdg_assessment_test
      - POSTGRES_HOST_AUTH_METHOD=trust
    # Use tmpfs for faster test execution (data in memory)
    tmpfs:
      - /var/lib/postgresql/data
    ports:
      - "5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test_user -d sdg_assessment_test"]
      interval: 3s
      timeout: 3s
      retries: 5
    networks:
      - test-network

  # Test web application
  web-test:
    build:
      context: .
      dockerfile: Dockerfile.test
    volumes:
      - .:/app
      - test-reports:/app/test-reports
    environment:
      - DATABASE_URL=postgresql://test_user:test_password@db-test:5432/sdg_assessment_test
      - SECRET_KEY=test-secret-key-not-for-production
      - FLASK_ENV=testing
      - FLASK_APP=run.py
      - TESTING=True
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    depends_on:
      db-test:
        condition: service_healthy
    networks:
      - test-network
    # Don't run by default - will be started by test runner script
    command: pytest --cov=app --cov-report=html --cov-report=xml --cov-report=term -v
    stdin_open: true
    tty: true

  # Selenium for E2E testing (Chrome headless)
  selenium:
    image: selenium/standalone-chrome:latest
    ports:
      - "4444:4444"
      - "7900:7900"  # VNC server for debugging
    environment:
      - SE_NODE_MAX_SESSIONS=5
      - SE_NODE_SESSION_TIMEOUT=300
      - SE_SCREEN_WIDTH=1920
      - SE_SCREEN_HEIGHT=1080
      - SE_VNC_NO_PASSWORD=1
    shm_size: 2gb  # Increase shared memory for Chrome
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "/opt/bin/check-grid.sh", "--host", "0.0.0.0", "--port", "4444"]
      interval: 10s
      timeout: 10s
      retries: 5

  # Redis for caching tests (optional)
  redis-test:
    image: redis:7-alpine
    ports:
      - "6380:6379"
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 3s
      timeout: 3s
      retries: 5

volumes:
  test-reports:
    driver: local

networks:
  test-network:
    driver: bridge
