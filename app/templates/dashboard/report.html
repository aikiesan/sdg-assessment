{% extends "base.html" %}

{% block title %}SDG Assessment Report{% endblock %}

{% block styles %}
<style>
  @media print {
    body {
      padding: 0;
      margin: 2cm;
      font-size: 10pt;
    }
    .no-print {
      display: none !important;
    }
    .page-break {
      page-break-before: always;
    }
    .chart-container {
      height: 300px;
      margin-bottom: 30px;
    }
    table {
      page-break-inside: avoid;
    }
    h1 {
      font-size: 24pt;
    }
    h2 {
      font-size: 16pt;
    }
    h3 {
      font-size: 14pt;
    }
    .table {
      font-size: 9pt;
    }
    .header-section {
      margin-bottom: 40px;
    }
  }
  
  .report-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }
  
  .company-logo {
    height: 50px;
    margin-bottom: 10px;
  }
  
  .header-section {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #dee2e6;
  }
  
  .chart-container {
    height: 300px;
    position: relative;
    margin-bottom: 20px;
  }
  
  .sdg-radar {
    height: 400px;
  }
  
  .sdg-badge {
    display: inline-block;
    width: 24px;
    height: 24px;
    line-height: 24px;
    text-align: center;
    border-radius: 50%;
    color: white;
    font-weight: bold;
    margin-right: 5px;
    font-size: 12px;
  }
  
  .project-card {
    margin-bottom: 20px;
  }
  
  .key-indicator {
    padding: 15px;
    text-align: center;
    margin-bottom: 20px;
  }
  
  .key-indicator .number {
    font-size: 2rem;
    font-weight: bold;
  }
  
  .key-indicator .label {
    font-size: 0.9rem;
    color: #6c757d;
  }
  
  .score-cell {
    width: 50px;
    height: 30px;
    text-align: center;
    color: white;
    font-weight: bold;
    border-radius: 4px;
    display: inline-block;
    line-height: 30px;
  }
</style>
{% endblock %}

{% block content %}
<div class="report-container">
  <!-- Print Button -->
  <div class="d-flex justify-content-between mb-4 no-print">
    <a href="{{ url_for('dashboard.index') }}" class="btn btn-outline-primary">
      <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
    <button onclick="window.print()" class="btn btn-primary">
      <i class="bi bi-printer"></i> Print Report
    </button>
  </div>

  <!-- Report Header -->
  <div class="header-section">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h1>SDG Assessment Report</h1>
        <p class="text-muted">Generated on {{ generated_at }}</p>
      </div>
      <div class="col-md-4 text-end">
        <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" class="company-logo" onerror="this.style.display='none'">
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-md-6">
        <p><strong>Organization:</strong> {{ user.organization or 'Not specified' }}</p>
        <p><strong>Generated by:</strong> {{ user.name }}</p>
        <p><strong>Email:</strong> {{ user.email }}</p>
      </div>
    </div>
  </div>

  <!-- Executive Summary -->
  <div class="mb-5">
    <h2>Executive Summary</h2>
    <div class="row mt-4">
      <div class="col-md-3">
        <div class="key-indicator shadow-sm border rounded">
          <div class="number">{{ project_count }}</div>
          <div class="label">Total Projects</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="key-indicator shadow-sm border rounded">
          <div class="number">{{ assessment_count }}</div>
          <div class="label">Assessments</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="key-indicator shadow-sm border rounded">
          <div class="number">{{ completion_rate|round|int }}%</div>
          <div class="label">Completion Rate</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="key-indicator shadow-sm border rounded">
          <div class="number">{{ avg_score|round(1) }}</div>
          <div class="label">Average SDG Score (0-5)</div>
        </div>
      </div>
    </div>
    
    <div class="row mt-4">
      <div class="col-md-6">
        <div class="chart-container">
          <canvas id="overallPerformanceChart"></canvas>
        </div>
      </div>
      <div class="col-md-6">
        <div class="chart-container">
          <canvas id="projectTypeChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- SDG Performance -->
  <div class="mb-5 page-break">
    <h2>SDG Performance Analysis</h2>
    <p>This section presents an analysis of how projects perform across each of the UN Sustainable Development Goals.</p>
    
    <div class="chart-container sdg-radar">
      <canvas id="sdgRadarChart"></canvas>
    </div>
    
    <div class="table-responsive mt-4">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>SDG</th>
            <th>Name</th>
            <th>Average Score</th>
            <th>Performance</th>
          </tr>
        </thead>
        <tbody>
          {% for sdg in sdg_performance %}
          <tr>
            <td>
              <div class="sdg-badge" style="background-color: {{ sdg.color_code }};">
                {{ sdg.number }}
              </div>
            </td>
            <td>{{ sdg.name }}</td>
            <td>{{ sdg.avg_score|round(1) }}</td>
            <td>
              <div class="progress" style="height: 20px;">
                <div class="progress-bar bg-{% if sdg.avg_score >= 4 %}success{% elif sdg.avg_score >= 3 %}primary{% elif sdg.avg_score >= 2 %}warning{% else %}danger{% endif %}" 
                     style="width: {{ (sdg.avg_score / 5 * 100)|round|int }}%">
                  {{ (sdg.avg_score / 5 * 100)|round|int }}%
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Projects Summary -->
  <div class="mb-5 page-break">
    <h2>Project Performance Summary</h2>
    <p>Overview of all projects and their SDG assessment scores.</p>
    
    <div class="table-responsive mt-4">
      <table class="table table-bordered table-hover">
        <thead>
          <tr>
            <th>Project Name</th>
            <th>Type</th>
            <th>Location</th>
            <th>Size (sqm)</th>
            <th>Status</th>
            <th>Overall Score</th>
          </tr>
        </thead>
        <tbody>
          {% for project in projects %}
          <tr>
            <td>{{ project.name }}</td>
            <td>{{ project.project_type or 'N/A' }}</td>
            <td>{{ project.location or 'N/A' }}</td>
            <td>{{ project.size_sqm or 'N/A' }}</td>
            <td>
              <span class="badge bg-{{ project.status == 'completed' ? 'success' : 'warning' }}">
                {{ project.status|capitalize if project.status else 'Not assessed' }}
              </span>
            </td>
            <td>
              {% if project.overall_score %}
              <div class="score-cell" style="background-color: 
                      {% if project.overall_score >= 4 %}#198754
                      {% elif project.overall_score >= 3 %}#0d6efd
                      {% elif project.overall_score >= 2 %}#ffc107
                      {% else %}#dc3545{% endif %};">
                {{ project.overall_score|round(1) }}
              </div>
              {% else %}
              <span class="text-muted">N/A</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Recommendations -->
  <div class="mb-5 page-break">
    <h2>Recommendations</h2>
    <p>Based on the assessment results, here are key recommendations to improve SDG alignment in future projects:</p>
    
    <div class="row mt-4">
      <!-- Find lowest scoring SDGs -->
      {% set low_scoring_sdgs = sdg_performance|sort(attribute='avg_score')|selectattr('avg_score', '<', 3.0)|list %}
      
      {% if low_scoring_sdgs|length > 0 %}
      <div class="col-md-6">
        <div class="card shadow-sm h-100">
          <div class="card-header">
            <h5 class="mb-0">Areas for Improvement</h5>
          </div>
          <div class="card-body">
            <p>The following SDGs have below-average scores and represent opportunities for improvement:</p>
            <ul class="list-group list-group-flush">
              {% for sdg in low_scoring_sdgs[:3] %}
              <li class="list-group-item">
                <div class="d-flex align-items-center">
                  <div class="sdg-badge" style="background-color: {{ sdg.color_code }};">{{ sdg.number }}</div>
                  <strong>{{ sdg.name }} ({{ sdg.avg_score|round(1) }})</strong>
                </div>
                <div class="mt-2">
                  {% if sdg.number == 1 %}
                  Consider incorporating affordable housing principles and focus on energy-efficient designs that reduce operational costs for occupants.
                  {% elif sdg.number == 2 %}
                  Integrate urban agriculture opportunities and community food spaces into project designs.
                  {% elif sdg.number == 3 %}
                  Emphasize biophilic design, natural lighting, and ventilation to improve health and wellbeing.
                  {% elif sdg.number == 4 %}
                  Include flexible learning spaces and educational facilities in community developments.
                  {% elif sdg.number == 5 %}
                  Implement gender-responsive design to ensure safety and accessibility for all users.
                  {% elif sdg.number == 6 %}
                  Incorporate water-efficient systems, rainwater harvesting, and greywater recycling.
                  {% elif sdg.number == 7 %}
                  Prioritize renewable energy integration and passive design strategies.
                  {% elif sdg.number == 8 %}
                  Focus on sustainable construction practices and local material sourcing.
                  {% elif sdg.number == 9 %}
                  Invest in resilient infrastructure and innovative construction techniques.
                  {% elif sdg.number == 10 %}
                  Apply universal design principles to reduce inequalities in access.
                  {% elif sdg.number == 11 %}
                  Enhance sustainable urban planning elements and public transportation access.
                  {% elif sdg.number == 12 %}
                  Implement material life cycle assessment and circular economy principles.
                  {% elif sdg.number == 13 %}
                  Develop climate-resilient designs and carbon-neutral strategies.
                  {% elif sdg.number == 14 %}
                  Improve marine pollution prevention measures and sustainable waterfront design.
                  {% elif sdg.number == 15 %}
                  Enhance biodiversity considerations and habitat restoration in projects.
                  {% elif sdg.number == 16 %}
                  Strengthen community engagement processes and transparent decision-making.
                  {% elif sdg.number == 17 %}
                  Expand partnerships and collaborative approaches with all stakeholders.
                  {% endif %}
                </div>
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
      {% endif %}
      
      <!-- Find highest scoring SDGs -->
      {% set high_scoring_sdgs = sdg_performance|sort(attribute='avg_score', reverse=true)|selectattr('avg_score', '>=', 3.5)|list %}
      
      <div class="col-md-6">
        <div class="card shadow-sm h-100">
          <div class="card-header">
            <h5 class="mb-0">Key Strengths</h5>
          </div>
          <div class="card-body">
            {% if high_scoring_sdgs|length > 0 %}
            <p>The following SDGs show strong performance and represent organizational strengths:</p>
            <ul class="list-group list-group-flush">
              {% for sdg in high_scoring_sdgs[:3] %}
              <li class="list-group-item">
                <div class="d-flex align-items-center">
                  <div class="sdg-badge" style="background-color: {{ sdg.color_code }};">{{ sdg.number }}</div>
                  <strong>{{ sdg.name }} ({{ sdg.avg_score|round(1) }})</strong>
                </div>
                <div class="mt-2">
                  Continue to leverage and build upon your strong performance in this area. Consider sharing best practices across project teams.
                </div>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <p>General recommendations for improving SDG alignment:</p>
            <ul class="list-group list-group-flush">
              <li class="list-group-item">
                <strong>Early Integration:</strong> Consider SDG impacts during the earliest design phases, not as an afterthought.
              </li>
              <li class="list-group-item">
                <strong>Holistic Approach:</strong> Look for synergies between different SDGs rather than treating them in isolation.
              </li>
              <li class="list-group-item">
                <strong>Stakeholder Engagement:</strong> Involve diverse stakeholders in the design and decision-making process.
              </li>
              <li class="list-group-item">
                <strong>Measurement:</strong> Implement quantitative metrics to track performance improvement over time.
              </li>
            </ul>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    
    <div class="mt-4">
      <div class="card shadow-sm">
        <div class="card-header">
          <h5 class="mb-0">Action Plan</h5>
        </div>
        <div class="card-body">
          <ol>
            <li><strong>Set Targets:</strong> Establish specific improvement targets for the lowest-scoring SDGs.</li>
            <li><strong>Training:</strong> Provide team training on sustainable design principles, particularly for low-scoring areas.</li>
            <li><strong>Checklists:</strong> Develop SDG checklists for each project phase from conception to completion.</li>
            <li><strong>Metrics:</strong> Implement performance metrics and regular assessments to track progress.</li>
            <li><strong>Knowledge Sharing:</strong> Create systems to share successful strategies across projects.</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <!-- Report Footer -->
  <div class="mt-5 pt-5 text-center">
    <p class="text-muted small">This report was generated using the SDG Assessment Tool for Architecture.</p>
    <p class="text-muted small">© {{ now.year }} - All rights reserved</p>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // SDG Performance Radar Chart
    const sdgLabels = {{ sdg_labels|tojson }};
    const sdgScores = {{ sdg_scores|tojson }};
    const sdgColors = {{ sdg_colors|tojson }};
    
    const radarCtx = document.getElementById('sdgRadarChart').getContext('2d');
    new Chart(radarCtx, {
      type: 'radar',
      data: {
        labels: sdgLabels.map(label => `SDG ${label}`),
        datasets: [{
          label: 'Average Score',
          data: sdgScores,
          backgroundColor: 'rgba(63, 126, 68, 0.2)',
          borderColor: '#3f7e44',
          pointBackgroundColor: sdgColors,
          pointBorderColor: '#fff',
          pointHoverBackgroundColor: '#fff',
          pointHoverBorderColor: sdgColors,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          r: {
            beginAtZero: true,
            max: 5,
            ticks: {
              stepSize: 1
            }
          }
        },
        plugins: {
          legend: {
            display: true,
            position: 'top'
          },
          title: {
            display: true,
            text: 'SDG Performance Overview (0-5 scale)'
          }
        }
      }
    });
    
    // Overall Performance Chart
    const overallCtx = document.getElementById('overallPerformanceChart').getContext('2d');
    new Chart(overallCtx, {
      type: 'bar',
      data: {
        labels: ['Poor (0-1)', 'Fair (1-2)', 'Average (2-3)', 'Good (3-4)', 'Excellent (4-5)'],
        datasets: [{
          label: 'Project Distribution',
          data: [
            {{ (sdg_scores|filter('<=', 1)|list|length / sdg_scores|length * 100)|round|int if sdg_scores|length else 0 }},
            {{ (sdg_scores|filter('>', 1)|filter('<=', 2)|list|length / sdg_scores|length * 100)|round|int if sdg_scores|length else 0 }},
            {{ (sdg_scores|filter('>', 2)|filter('<=', 3)|list|length / sdg_scores|length * 100)|round|int if sdg_scores|length else 0 }},
            {{ (sdg_scores|filter('>', 3)|filter('<=', 4)|list|length / sdg_scores|length * 100)|round|int if sdg_scores|length else 0 }},
            {{ (sdg_scores|filter('>', 4)|list|length / sdg_scores|length * 100)|round|int if sdg_scores|length else 0 }}
          ],
          backgroundColor: [
            '#dc3545',
            '#ffc107',
            '#0dcaf0',
            '#0d6efd',
            '#198754'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: {
              callback: function(value) {
                return value + '%';
              }
            }
          }
        },
        plugins: {
          legend: {
            display: false
          },
          title: {
            display: true,
            text: 'Overall Score Distribution'
          }
        }
      }
    });
    
    // Create chart data for project types
    // This is a placeholder - you'll need to calculate this data in your route
    const projectTypeCtx = document.getElementById('projectTypeChart').getContext('2d');
    new Chart(projectTypeCtx, {
      type: 'doughnut',
      data: {
        labels: ['Residential', 'Commercial', 'Institutional', 'Industrial', 'Mixed-Use', 'Other'],
        datasets: [{
          data: [30, 20, 15, 10, 15, 10], // Replace with actual data
          backgroundColor: [
            '#3f7e44',
            '#26bde2',
            '#dda63a',
            '#c5192d',
            '#ff3a21', 
            '#4c9f38'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right'
          },
          title: {
            display: true,
            text: 'Projects by Type'
          }
        }
      }
    });
  });
</script>
{% endblock %}
